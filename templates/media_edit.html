{% extends "base.html" %}
{% block title %}Edit: {{ media.title }}{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto">
    <a href="/manage/{{ media_type }}" class="text-sm text-indigo-600 hover:underline mb-4 inline-flex items-center"><i class="fas fa-arrow-left mr-2"></i>Back to {{ media_type|title }}s</a>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1"><div class="bg-white rounded-xl shadow-md p-6 sticky top-8"><img id="poster-preview" src="{{ media.poster or 'https://via.placeholder.com/300x450' }}" alt="{{ media.title }}" class="w-full rounded-lg shadow-lg mb-4 aspect-[2/3] object-cover" onerror="this.src='https://via.placeholder.com/300x450'"><h1 id="title-preview" class="text-2xl font-bold text-gray-900">{{ media.title }}</h1><div class="flex items-center text-sm text-gray-500 mt-2"><span id="year-preview">{{ media.release_year }}</span><span class="mx-2">&bull;</span><span class="flex items-center"><i class="fas fa-star text-yellow-400 mr-1"></i> <span id="rating-preview">{{ media.rating }}</span></span></div><p id="description-preview" class="text-sm text-gray-600 mt-4 max-h-48 overflow-y-auto">{{ media.description }}</p></div></div>
        <div class="lg:col-span-2 space-y-8">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center border-b pb-3 mb-4"><h2 class="text-xl font-semibold">General Details</h2><button id="refetch-btn" onclick="handleRefetch()" class="text-sm bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors"><i class="fas fa-sync-alt mr-2"></i>Refetch from TMDb</button></div>
                <form id="details-form" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">Title</label><input type="text" name="title" value="{{ media.title }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Release Year</label><input type="number" name="release_year" value="{{ media.release_year }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div><div><label class="block text-sm font-medium text-gray-700">Rating</label><input type="number" step="0.1" name="rating" value="{{ media.rating }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div></div>
                    <div><label class="block text-sm font-medium text-gray-700">Poster URL</label><input type="url" name="poster" value="{{ media.poster }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Backdrop URL</label><input type="url" name="backdrop" value="{{ media.backdrop }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Logo URL</label><input type="url" name="logo" value="{{ media.logo }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Genres (comma-separated)</label><input type="text" name="genres" value="{{ media.genres|join(', ') }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Description</label><textarea name="description" rows="4" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">{{ media.description }}</textarea></div>
                    <div class="text-right"><button type="submit" class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 font-medium transition-colors">Save Details</button></div>
                </form>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-3">Manage Content</h2>
                {% if media_type == 'movie' %}<div id="streams-container" class="space-y-3">{% for stream in media.streams|sort(attribute='quality') %}<div class="stream-item flex items-center p-3 bg-gray-50 rounded-md border gap-3"><input type="text" value="{{ stream.quality }}" class="quality-input w-20 px-2 py-1 border rounded text-sm" placeholder="Quality"><input type="text" value="{{ stream.name }}" class="name-input flex-1 px-2 py-1 border rounded text-sm" placeholder="Name"><input type="text" value="{{ stream.url }}" class="url-input flex-1 px-2 py-1 border rounded text-sm" placeholder="URL"><button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-trash-alt"></i></button></div>{% endfor %}</div><div class="mt-4"><button onclick="addStream()" class="text-sm bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">+ Add Stream</button></div>
                {% else %}<div class="space-y-4">{% for season in media.seasons|sort(attribute='season_number') %}<div class="season-item border rounded-lg"><div class="bg-gray-100 p-3 flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('i.fa-chevron-down').classList.toggle('rotate-180')"><h3 class="font-semibold">Season <input type="number" value="{{ season.season_number }}" class="season-number-input w-16 px-2 py-1 border rounded text-sm"></h3><div class="flex items-center space-x-4"><button onclick="event.stopPropagation(); this.closest('.season-item').remove()" class="text-red-500 hover:text-red-700 text-xs font-semibold"><i class="fas fa-trash"></i> Season</button><i class="fas fa-chevron-down transition-transform"></i></div></div><div class="p-3 space-y-3 hidden">{% for episode in season.episodes|sort(attribute='episode_number') %}<div class="episode-item border rounded-md p-3"><div class="flex justify-between items-start mb-2"><p class="font-medium text-sm">E<input type="number" value="{{ episode.episode_number }}" class="episode-number-input w-12 px-1 border rounded text-sm">: <input type="text" value="{{ episode.title }}" class="episode-title-input flex-1 px-2 border rounded text-sm"></p><button onclick="this.closest('.episode-item').remove()" class="text-red-500 hover:text-red-700 text-xs font-semibold"><i class="fas fa-trash"></i> Episode</button></div><div class="streams-container space-y-2">{% for stream in episode.streams|sort(attribute='quality') %}<div class="stream-item flex items-center gap-2 p-2 bg-gray-50 rounded"><input type="text" value="{{ stream.quality }}" class="quality-input w-20 px-2 py-1 border rounded text-xs" placeholder="Quality"><input type="text" value="{{ stream.name }}" class="name-input flex-1 px-2 py-1 border rounded text-xs" placeholder="Name"><input type="text" value="{{ stream.url }}" class="url-input flex-1 px-2 py-1 border rounded text-xs" placeholder="URL"><button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 text-xs"><i class="fas fa-trash-alt"></i></button></div>{% endfor %}</div><button onclick="addStream(this.previousElementSibling)" class="text-xs bg-gray-100 px-3 py-1 rounded mt-2 hover:bg-gray-200">+ Add Stream</button></div>{% endfor %}<button onclick="addEpisode(this.parentElement)" class="text-sm bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 mt-2">+ Add Episode</button></div></div>{% endfor %}<div class="mt-4"><button onclick="addSeason()" class="text-sm bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">+ Add Season</button></div></div>{% endif %}
                <div class="text-right mt-6"><button onclick="handleSaveChanges()" class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 font-medium transition-colors">Save All Content Changes</button></div>
            </div>
            <div class="bg-red-50 p-6 rounded-xl border border-red-200"><h2 class="text-xl font-semibold text-red-800 mb-2">Danger Zone</h2><p class="text-sm text-red-700 mb-4">Deleting this media item is permanent and cannot be undone.</p><button onclick="deleteEntireMedia()" class="bg-red-600 text-white px-5 py-2 rounded-md hover:bg-red-700 font-medium transition-colors">Delete This {{ media_type|title }}</button></div>
        </div>
    </div>
</div>
<script>
const mediaType = '{{ media_type }}', tmdbId = {{ media.tmdb_id }};
function showToast(msg,isErr=false){const t=document.createElement("div");t.className=`fixed top-5 right-5 ${isErr?"bg-red-600":"bg-green-600"} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-pulse`,t.textContent=msg,document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}
async function saveChanges(data){try{const t=await fetch(`/api/media/${mediaType}/${tmdbId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});if(!t.ok)throw new Error((await t.json()).detail||"Failed to save.");showToast("Changes saved successfully!"),setTimeout(()=>window.location.reload(),1e3)}catch(e){showToast(e.message,!0)}}
document.getElementById("details-form").addEventListener("submit",async e=>{e.preventDefault();const t=new FormData(e.target),n={};t.forEach((e,t)=>n[t]=e),n.genres=n.genres.split(",").map(e=>e.trim()).filter(e=>e),n.release_year=parseInt(n.release_year,10),n.rating=parseFloat(n.rating),await saveChanges(n)});
async function handleSaveChanges(){const t={};if(mediaType==="movie")t.streams=Array.from(document.querySelectorAll("#streams-container .stream-item")).map(e=>({quality:e.querySelector(".quality-input").value,name:e.querySelector(".name-input").value,url:e.querySelector(".url-input").value}));else{t.seasons=[];for(const e of document.querySelectorAll(".season-item")){const n=parseInt(e.querySelector(".season-number-input").value,10),s={season_number:n,episodes:[]};for(const t of e.querySelectorAll(".episode-item")){const n=parseInt(t.querySelector(".episode-number-input").value,10),o=t.querySelector(".episode-title-input").value,a={episode_number:n,title:o,streams:[]};for(const e of t.querySelectorAll(".stream-item"))a.streams.push({quality:e.querySelector(".quality-input").value,name:e.querySelector(".name-input").value,url:e.querySelector(".url-input").value});s.episodes.push(a)}t.seasons.push(s)}}await saveChanges(t)}
async function handleRefetch(){const e=document.getElementById("refetch-btn");e.disabled=!0,e.innerHTML='<i class="fas fa-sync-alt mr-2 animate-spin"></i>Fetching...';try{const t=await fetch(`/api/refetch-tmdb/${mediaType}/${tmdbId}`);if(!t.ok)throw new Error("Failed to fetch data.");const n=await t.json();document.querySelector('[name="title"]').value=n.title,document.querySelector('[name="release_year"]').value=n.release_year,document.querySelector('[name="rating"]').value=n.rating,document.querySelector('[name="poster"]').value=n.poster,document.querySelector('[name="backdrop"]').value=n.backdrop,document.querySelector('[name="logo"]').value=n.logo,document.querySelector('[name="description"]').value=n.description,document.querySelector('[name="genres"]').value=n.genres.join(", "),showToast("Data refetched. Review and save.")}catch(t){showToast(t.message,!0)}finally{e.disabled=!1,e.innerHTML='<i class="fas fa-sync-alt mr-2"></i>Refetch from TMDb'}}
async function deleteEntireMedia(){if(!confirm("PERMANENTLY DELETE this entire media item?"))return;try{const e=await fetch(`/api/media/${mediaType}/${tmdbId}`,{method:"DELETE"});if(!e.ok)throw new Error((await e.json()).detail);showToast("Media deleted. Redirecting..."),setTimeout(()=>window.location.href=`/manage/${mediaType}`,2e3)}catch(e){showToast(e.message,!0)}}
function createStreamHTML(){return'<div class="stream-item flex items-center p-3 bg-gray-50 rounded-md border gap-3"><input type="text" class="quality-input w-20 px-2 py-1 border rounded text-sm" placeholder="1080p"><input type="text" class="name-input flex-1 px-2 py-1 border rounded text-sm" placeholder="File Name"><input type="text" class="url-input flex-1 px-2 py-1 border rounded text-sm" placeholder="DDL URL"><button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-trash-alt"></i></button></div>'}
function addStream(e=null){(e||document.getElementById("streams-container")).insertAdjacentHTML("beforeend",createStreamHTML())}
function addEpisode(e){e.insertAdjacentHTML("beforeend",`<div class="episode-item border rounded-md p-3"><div class="flex justify-between items-start mb-2"><p class="font-medium text-sm">E<input type="number" value="" class="episode-number-input w-12 px-1 border rounded text-sm">: <input type="text" value="" class="episode-title-input flex-1 px-2 border rounded text-sm"></p><button onclick="this.closest('.episode-item').remove()" class="text-red-500 hover:text-red-700 text-xs font-semibold"><i class="fas fa-trash"></i> Episode</button></div><div class="streams-container space-y-2"></div><button onclick="addStream(this.previousElementSibling)" class="text-xs bg-gray-100 px-3 py-1 rounded mt-2 hover:bg-gray-200">+ Add Stream</button></div>`)}
function addSeason(){const e=document.querySelector(".space-y-4"),t=e.querySelectorAll(".season-item").length+1;e.insertAdjacentHTML("beforeend",`<div class="season-item border rounded-lg"><div class="bg-gray-100 p-3 flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('i.fa-chevron-down').classList.toggle('rotate-180')"><h3 class="font-semibold">Season <input type="number" value="${t}" class="season-number-input w-16 px-2 py-1 border rounded text-sm"></h3><div class="flex items-center space-x-4"><button onclick="event.stopPropagation(); this.closest('.season-item').remove()" class="text-red-500 hover:text-red-700 text-xs font-semibold"><i class="fas fa-trash"></i> Season</button><i class="fas fa-chevron-down transition-transform"></i></div></div><div class="p-3 space-y-3"><button onclick="addEpisode(this.parentElement)" class="text-sm bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 mt-2">+ Add Episode</button></div></div>`)}
</script>
{% endblock %}
