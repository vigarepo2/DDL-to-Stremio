{% extends "base.html" %}

{% block title %}Edit: {{ media.title }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <a href="/manage/{{ media_type }}" class="text-sm text-indigo-600 hover:underline mb-4 inline-flex items-center">
        <i class="fas fa-arrow-left mr-2"></i>Back to {{ media_type|title }}s
    </a>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-md p-6 sticky top-8">
                <img id="poster-preview" src="{{ media.poster }}" alt="{{ media.title }}" class="w-full rounded-lg shadow-lg mb-4 aspect-[2/3] object-cover" onerror="this.src='https://via.placeholder.com/300x450/e5e7eb/9ca3af?text=No+Image'">
                <h1 id="title-preview" class="text-2xl font-bold text-gray-900">{{ media.title }}</h1>
                <div class="flex items-center text-sm text-gray-500 mt-2">
                    <span id="year-preview">{{ media.release_year }}</span>
                    <span class="mx-2">&bull;</span>
                    <span class="flex items-center"><i class="fas fa-star text-yellow-400 mr-1"></i> <span id="rating-preview">{{ media.rating }}</span></span>
                </div>
                <p id="description-preview" class="text-sm text-gray-600 mt-4 max-h-48 overflow-y-auto">{{ media.description }}</p>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-8">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-3">General Details</h2>
                <form id="details-form" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">Title</label><input type="text" name="title" value="{{ media.title }}" oninput="document.getElementById('title-preview').textContent = this.value" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Release Year</label><input type="number" name="release_year" value="{{ media.release_year }}" oninput="document.getElementById('year-preview').textContent = this.value" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Rating</label><input type="number" step="0.1" name="rating" value="{{ media.rating }}" oninput="document.getElementById('rating-preview').textContent = this.value" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700">Poster URL</label><input type="url" name="poster" value="{{ media.poster }}" oninput="document.getElementById('poster-preview').src = this.value" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Backdrop URL</label><input type="url" name="backdrop" value="{{ media.backdrop }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Genres (comma-separated)</label><input type="text" name="genres" value="{{ media.genres|join(', ') }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Description</label><textarea name="description" rows="4" oninput="document.getElementById('description-preview').textContent = this.value" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">{{ media.description }}</textarea></div>
                    <div class="text-right"><button type="submit" class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 font-medium transition-colors">Save Details</button></div>
                </form>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-3">Manage Content</h2>
                {% if media_type == 'movie' %}
                    <div id="streams-list" class="space-y-3">
                        {% for stream in media.streams|sort(attribute='quality') %}
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-md border">
                            <div><span class="font-semibold text-indigo-700 bg-indigo-100 px-2 py-1 rounded-full text-xs">{{ stream.quality }}</span><span class="text-sm text-gray-500 ml-3">{{ stream.size }}</span><p class="text-xs text-gray-400 mt-1 truncate">{{ stream.name }}</p></div>
                            <button onclick="deleteStream('{{ stream.quality }}')" class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="space-y-4">
                        {% for season in media.seasons|sort(attribute='season_number') %}
                        <div class="border rounded-lg">
                            <div class="bg-gray-50 p-3 flex justify-between items-center cursor-pointer" onclick="toggleSeason({{ loop.index }})">
                                <h3 class="font-semibold">Season {{ season.season_number }}</h3>
                                <div class="flex items-center space-x-4"><span class="text-xs text-gray-500">{{ season.episodes|length }} Episodes</span><button onclick="event.stopPropagation(); deleteSeason({{ season.season_number }})" class="text-red-500 hover:text-red-700 text-xs font-semibold"><i class="fas fa-trash"></i> Season</button><i id="season-arrow-{{ loop.index }}" class="fas fa-chevron-down transition-transform"></i></div>
                            </div>
                            <div id="season-content-{{ loop.index }}" class="hidden p-3 space-y-3">
                                {% for episode in season.episodes|sort(attribute='episode_number') %}
                                <div class="border rounded-md p-3">
                                    <div class="flex justify-between items-start mb-2"><p class="font-medium text-sm">E{{ episode.episode_number }}: {{ episode.title }}</p><button onclick="deleteEpisode({{ season.season_number }}, {{ episode.episode_number }})" class="text-red-500 hover:text-red-700 text-xs font-semibold"><i class="fas fa-trash"></i> Episode</button></div>
                                    <div class="space-y-2">
                                        {% for stream in episode.streams|sort(attribute='quality') %}
                                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded"><p><span class="font-semibold text-indigo-700 bg-indigo-100 px-2 py-0.5 rounded-full text-xs">{{ stream.quality }}</span><span class="text-xs text-gray-500 ml-2">{{ stream.size }}</span></p><button onclick="deleteStream({{ season.season_number }}, {{ episode.episode_number }}, '{{ stream.quality }}')" class="text-red-500 hover:text-red-700 text-xs"><i class="fas fa-trash-alt"></i></button></div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="bg-red-50 p-6 rounded-xl border border-red-200">
                <h2 class="text-xl font-semibold text-red-800 mb-2">Danger Zone</h2>
                <p class="text-sm text-red-700 mb-4">Deleting this media item is permanent and cannot be undone.</p>
                <button onclick="deleteEntireMedia()" class="bg-red-600 text-white px-5 py-2 rounded-md hover:bg-red-700 font-medium transition-colors">Delete This {{ media_type|title }}</button>
            </div>
        </div>
    </div>
</div>

<script>
    const mediaType = '{{ media_type }}';
    const tmdbId = {{ media.tmdb_id }};
    let mediaObject = {{ media|tojson|safe }};

    function showToast(message, isError = false) {
        const toast = document.createElement('div');
        toast.className = `fixed top-5 right-5 ${isError ? 'bg-red-600' : 'bg-green-600'} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-pulse`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    async function saveChanges(updatedMedia) {
        try {
            const response = await fetch(`/api/media/${mediaType}/${tmdbId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedMedia)
            });
            if (!response.ok) throw new Error((await response.json()).detail || 'Failed to save changes.');
            showToast('Changes saved successfully!');
            setTimeout(() => window.location.reload(), 1000);
        } catch (error) { showToast(error.message, true); }
    }

    document.getElementById('details-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const updatedData = {};
        formData.forEach((value, key) => updatedData[key] = value);
        updatedData.genres = updatedData.genres.split(',').map(g => g.trim()).filter(g => g);
        updatedData.release_year = parseInt(updatedData.release_year, 10);
        updatedData.rating = parseFloat(updatedData.rating);
        await saveChanges({ ...mediaObject, ...updatedData });
    });

    function deleteStream(param1, param2, param3) {
        let quality;
        if (mediaType === 'movie') {
            quality = param1;
            if (!confirm(`Delete ${quality} stream?`)) return;
            mediaObject.streams = mediaObject.streams.filter(s => s.quality !== quality);
        } else {
            const [seasonNum, episodeNum] = [param1, param2];
            quality = param3;
            if (!confirm(`Delete ${quality} stream from S${seasonNum}E${episodeNum}?`)) return;
            const season = mediaObject.seasons.find(s => s.season_number === seasonNum);
            const episode = season.episodes.find(e => e.episode_number === episodeNum);
            episode.streams = episode.streams.filter(s => s.quality !== quality);
        }
        saveChanges(mediaObject);
    }

    function deleteEpisode(seasonNum, episodeNum) {
        if (!confirm(`Delete S${seasonNum}E${episodeNum} entirely?`)) return;
        const season = mediaObject.seasons.find(s => s.season_number === seasonNum);
        season.episodes = season.episodes.filter(e => e.episode_number !== episodeNum);
        saveChanges(mediaObject);
    }

    function deleteSeason(seasonNum) {
        if (!confirm(`Delete entire Season ${seasonNum}?`)) return;
        mediaObject.seasons = mediaObject.seasons.filter(s => s.season_number !== seasonNum);
        saveChanges(mediaObject);
    }

    async function deleteEntireMedia() {
        if (!confirm('PERMANENTLY DELETE this entire media item?')) return;
        try {
            const response = await fetch(`/api/media/${mediaType}/${tmdbId}`, { method: 'DELETE' });
            if (!response.ok) throw new Error((await response.json()).detail);
            showToast('Media deleted. Redirecting...');
            setTimeout(() => window.location.href = `/manage/${mediaType}`, 2000);
        } catch (error) { showToast(error.message, true); }
    }

    function toggleSeason(index) {
        document.getElementById(`season-content-${index}`).classList.toggle('hidden');
        document.getElementById(`season-arrow-${index}`).classList.toggle('rotate-180');
    }
</script>
{% endblock %}
