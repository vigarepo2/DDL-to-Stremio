{% extends "base.html" %}

{% block title %}Edit: {{ media.title }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <a href="/manage/{{ media_type }}" class="text-sm text-indigo-600 hover:underline mb-4 inline-flex items-center"><i class="fas fa-arrow-left mr-2"></i>Back to {{ media_type|title }}s</a>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-md p-6 sticky top-8">
                <img id="poster-preview" src="{{ media.poster or 'https://via.placeholder.com/300x450' }}" alt="{{ media.title }}" class="w-full rounded-lg shadow-lg mb-4 aspect-[2/3] object-cover" onerror="this.src='https://via.placeholder.com/300x450/e5e7eb/9ca3af?text=No+Image'">
                <h1 id="title-preview" class="text-2xl font-bold text-gray-900">{{ media.title }}</h1>
                <div class="flex items-center text-sm text-gray-500 mt-2">
                    <span id="year-preview">{{ media.release_year }}</span><span class="mx-2">&bull;</span><span class="flex items-center"><i class="fas fa-star text-yellow-400 mr-1"></i> <span id="rating-preview">{{ media.rating }}</span></span>
                </div>
                <p id="description-preview" class="text-sm text-gray-600 mt-4 max-h-48 overflow-y-auto">{{ media.description }}</p>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-8">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-wrap gap-4 justify-between items-center border-b pb-3 mb-4">
                    <h2 class="text-xl font-semibold">General Details</h2>
                    <div class="flex gap-2">
                        <button id="refetch-btn" onclick="handleRefetch()" class="text-sm bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors disabled:bg-blue-300"><i class="fas fa-sync-alt mr-2"></i>Refetch</button>
                        <button onclick="openImageSelector()" class="text-sm bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors"><i class="fas fa-images mr-2"></i>Change Images</button>
                    </div>
                </div>
                <form id="details-form" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">Title</label><input type="text" name="title" value="{{ media.title }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Release Year</label><input type="number" name="release_year" value="{{ media.release_year }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Rating</label><input type="number" step="0.1" name="rating" value="{{ media.rating }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700">Poster URL</label><input type="url" name="poster" value="{{ media.poster or '' }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Backdrop URL</label><input type="url" name="backdrop" value="{{ media.backdrop or '' }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Logo URL</label><input type="url" name="logo" value="{{ media.logo or '' }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Genres (comma-separated)</label><input type="text" name="genres" value="{{ media.genres|join(', ') }}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Description</label><textarea name="description" rows="4" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">{{ media.description }}</textarea></div>
                </form>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-3">Manage Content</h2>
                <div id="content-container"></div>
            </div>
            <div class="bg-red-50 p-6 rounded-xl border border-red-200">
                <h2 class="text-xl font-semibold text-red-800 mb-2">Danger Zone</h2>
                <p class="text-sm text-red-700 mb-4">Deleting this media item is permanent and cannot be undone.</p>
                <button onclick="deleteEntireMedia()" class="bg-red-600 text-white px-5 py-2 rounded-md hover:bg-red-700 font-medium transition-colors">Delete This {{ media_type|title }}</button>
            </div>
        </div>
    </div>
</div>

<div id="save-bar" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm border-t border-gray-200 p-4 shadow-lg md:left-64 z-40 transform translate-y-full transition-transform">
    <div class="max-w-7xl mx-auto flex justify-end">
        <button id="save-button" onclick="handleSaveChanges()" class="bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 font-bold transition-colors shadow-lg flex items-center disabled:bg-indigo-400">
            <i class="fas fa-save mr-2"></i>Save All Changes
        </button>
    </div>
</div>

<div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center p-4 border-b">
            <div class="flex items-center gap-4"><h2 class="text-xl font-semibold">Select Image</h2><select id="lang-filter" class="text-sm border-gray-300 rounded-md"></select></div>
            <button onclick="closeImageSelector()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div class="flex border-b">
            <button id="tab-posters" onclick="switchTab('posters')" class="px-4 py-2 font-medium text-sm border-b-2 border-indigo-500 text-indigo-600">Posters</button>
            <button id="tab-backdrops" onclick="switchTab('backdrops')" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">Backdrops</button>
            <button id="tab-logos" onclick="switchTab('logos')" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">Logos</button>
        </div>
        <div id="image-galleries" class="p-4 overflow-y-auto">
            <div id="gallery-posters" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4"></div>
            <div id="gallery-backdrops" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden"></div>
            <div id="gallery-logos" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden bg-gray-800 p-4 rounded-lg"></div>
        </div>
    </div>
</div>

<script>
    const mediaType = '{{ media_type }}', tmdbId = {{ media.tmdb_id }};
    let mediaObject = {{ media|tojson|safe }};
    let imageDataCache = null, hasUnsavedChanges = false;

    function setUnsavedChanges(status) {
        if (status === hasUnsavedChanges) return;
        hasUnsavedChanges = status;
        document.getElementById('save-bar').classList.toggle('translate-y-full', !status);
        window.onbeforeunload = status ? () => "You have unsaved changes. Are you sure you want to leave?" : null;
    }

    async function handleSaveChanges() {
        const button = document.getElementById('save-button');
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

        const detailsForm = new FormData(document.getElementById('details-form'));
        const updatedDetails = {};
        detailsForm.forEach((value, key) => updatedDetails[key] = value);
        updatedDetails.genres = updatedDetails.genres.split(',').map(g => g.trim()).filter(g => g);
        updatedDetails.release_year = parseInt(updatedDetails.release_year, 10) || 0;
        updatedDetails.rating = parseFloat(updatedDetails.rating) || 0;

        const contentData = {};
        if (mediaType === 'movie') {
            contentData.streams = Array.from(document.querySelectorAll("#content-container .stream-item")).map(item => ({
                quality: item.querySelector(".quality-input").value.trim(),
                name: item.querySelector(".name-input").value.trim(),
                url: item.querySelector(".url-input").value.trim(),
                size: item.querySelector(".size-input").value.trim()
            }));
        } else {
            contentData.seasons = Array.from(document.querySelectorAll(".season-item")).map(seasonEl => ({
                season_number: parseInt(seasonEl.querySelector(".season-number-input").value, 10),
                episodes: Array.from(seasonEl.querySelectorAll(".episode-item")).map(episodeEl => ({
                    episode_number: parseInt(episodeEl.querySelector(".episode-number-input").value, 10),
                    title: episodeEl.querySelector(".episode-title-input").value.trim(),
                    streams: Array.from(episodeEl.querySelectorAll(".stream-item")).map(streamEl => ({
                        quality: streamEl.querySelector(".quality-input").value.trim(),
                        name: streamEl.querySelector(".name-input").value.trim(),
                        url: streamEl.querySelector(".url-input").value.trim(),
                        size: streamEl.querySelector(".size-input").value.trim()
                    }))
                }))
            }));
        }

        const finalData = { ...mediaObject, ...updatedDetails, ...contentData };

        try {
            const response = await fetch(`/api/media/${mediaType}/${tmdbId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalData)
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({ detail: 'Failed to save with status ' + response.status }));
                throw new Error(error.detail);
            }
            showToast('Changes saved successfully! Reloading...');
            setUnsavedChanges(false);
            setTimeout(() => window.location.reload(), 2000);
        } catch (error) {
            showToast(error.message, true);
        } finally {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-save mr-2"></i>Save All Changes';
        }
    }
    
    function createStreamHTML(s = {}) {
        return `<div class="stream-item flex flex-col sm:flex-row items-stretch sm:items-center p-3 bg-gray-50 rounded-md border gap-3">
            <input type="text" class="quality-input w-full sm:w-20 px-2 py-1.5 border rounded text-sm" placeholder="1080p" value="${s.quality || ""}">
            <input type="text" class="size-input w-full sm:w-24 px-2 py-1.5 border rounded text-sm" placeholder="1.23 GB" value="${s.size || ""}">
            <input type="text" class="name-input flex-1 px-2 py-1.5 border rounded text-sm" placeholder="File Name" value="${s.name || ""}">
            <input type="text" class="url-input flex-1 px-2 py-1.5 border rounded text-sm" placeholder="DDL URL" value="${s.url || ""}">
            <button type="button" onclick="this.parentElement.remove(); setUnsavedChanges(true);" class="text-red-500 hover:text-red-700 text-sm p-2"><i class="fas fa-trash-alt"></i></button>
        </div>`;
    }

    document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("content-container");
        if (mediaType === 'movie') {
            let html = '<div id="streams-list" class="space-y-3">';
            mediaObject.streams.forEach(s => html += createStreamHTML(s));
            html += '</div><div class="mt-4"><button type="button" onclick="addStream(document.getElementById(\'streams-list\'))" class="text-sm bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">+ Add Stream</button></div>';
            container.innerHTML = html;
        } else {
            let html = '<div class="space-y-4">';
            mediaObject.seasons.forEach(s => html += createSeasonHTML(s, mediaObject.seasons.length === 1));
            html += '</div><div class="mt-4"><button type="button" onclick="addSeason()" class="text-sm bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">+ Add Season</button></div>';
            container.innerHTML = html;
        }

        document.querySelector('body').addEventListener('input', () => setUnsavedChanges(true));
    });

    function createEpisodeHTML(e={}){let t="";e.streams?.forEach(e=>{t+=createStreamHTML(e)});return`<div class="episode-item border rounded-md p-3"><div class="flex justify-between items-start mb-2 gap-2"><div class="font-medium text-sm flex-1 mr-2 flex items-center gap-2">E<input type="number" class="episode-number-input w-16 px-1.5 py-1 border rounded text-sm" value="${e.episode_number||""}">: <input type="text" class="episode-title-input w-full px-2 py-1 border rounded text-sm" value="${e.title||""}"></div><button type="button" onclick="this.closest('.episode-item').remove(); setUnsavedChanges(true);" class="text-red-500 hover:text-red-700 text-xs font-semibold px-2 py-1 rounded hover:bg-red-50"><i class="fas fa-trash"></i> Episode</button></div><div class="streams-container space-y-2">${t}</div><button type="button" onclick="addStream(this.previousElementSibling)" class="text-xs bg-gray-100 px-3 py-1.5 rounded mt-2 hover:bg-gray-200">+ Add Stream</button></div>`}
    function addEpisode(e){e.insertAdjacentHTML("beforeend",createEpisodeHTML()); setUnsavedChanges(true);}
    function createSeasonHTML(e={}, startOpen=false){let t="";e.episodes?.forEach(e=>{t+=createEpisodeHTML(e)});const hiddenClass=startOpen?"":"hidden";const rotatedClass=startOpen?"rotate-180":"";return`<div class="season-item border rounded-lg"><div class="bg-gray-50 p-3 flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('i.fa-chevron-down').classList.toggle('rotate-180')"><h3 class="font-semibold flex items-center gap-2">Season <input type="number" class="season-number-input w-20 px-2 py-1 border rounded text-sm" value="${e.season_number||""}"></h3><div class="flex items-center space-x-4"><button type="button" onclick="event.stopPropagation(); this.closest('.season-item').remove(); setUnsavedChanges(true);" class="text-red-500 hover:text-red-700 text-xs font-semibold px-2 py-1 rounded hover:bg-red-50"><i class="fas fa-trash"></i> Season</button><i class="fas fa-chevron-down transition-transform ${rotatedClass}"></i></div></div><div class="p-3 space-y-3 ${hiddenClass}">${t}<button type="button" onclick="addEpisode(this.parentElement)" class="text-sm bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 mt-2">+ Add Episode</button></div></div>`}
    function addSeason(){const e=document.querySelector("#content-container > div.space-y-4");e.insertAdjacentHTML("beforeend",createSeasonHTML({season_number:e.querySelectorAll(".season-item").length+1}, true)); setUnsavedChanges(true);}
    function addStream(e){e.insertAdjacentHTML("beforeend",createStreamHTML()); setUnsavedChanges(true);}

    function showToast(msg,isErr=false){const t=document.createElement("div");t.className=`fixed top-5 right-5 ${isErr?"bg-red-600":"bg-green-600"} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-pulse`,t.textContent=msg,document.body.appendChild(t),setTimeout(()=>t.remove(),4e3)}
    async function handleRefetch(){const e=document.getElementById("refetch-btn");e.disabled=!0,e.innerHTML='<i class="fas fa-sync-alt mr-2 animate-spin"></i>Fetching...';try{const t=await fetch(`/api/refetch-tmdb/${mediaType}/${tmdbId}`);if(!t.ok)throw new Error("Failed to fetch data from TMDb.");const n=await t.json();["title","release_year","rating","poster","backdrop","logo","description"].forEach(e=>{const t=document.querySelector(`[name="${e}"]`);t&&(t.value=n[e]||"")}),document.querySelector('[name="genres"]').value=n.genres.join(", "),showToast("Data refetched. Review and save changes."),setUnsavedChanges(true)}catch(t){showToast(t.message,!0)}finally{e.disabled=!1,e.innerHTML='<i class="fas fa-sync-alt mr-2"></i>Refetch'}}
    async function deleteEntireMedia(){if(!confirm("Are you sure you want to PERMANENTLY DELETE this entire media item? This cannot be undone."))return;try{const e=await fetch(`/api/media/${mediaType}/${tmdbId}`,{method:"DELETE"});if(!e.ok)throw new Error((await e.json()).detail||"Deletion failed.");showToast("Media deleted successfully. Redirecting..."),setUnsavedChanges(false),setTimeout(()=>window.location.href=`/manage/${mediaType}`,2e3)}catch(e){showToast(e.message,!0)}}
    function openImageSelector(){document.getElementById('image-modal').classList.remove('hidden');handleFetchImages()}
    function closeImageSelector(){document.getElementById('image-modal').classList.add('hidden')}
    async function handleFetchImages(){if(imageDataCache)return renderImages(imageDataCache);const e=["posters","backdrops","logos"];for(const t of e)document.getElementById(`gallery-${t}`).innerHTML='<div class="col-span-full text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-gray-400"></i></div>';try{const t=await fetch(`/api/images/${mediaType}/${tmdbId}`);if(!t.ok)throw new Error("Could not fetch images from TMDb.");imageDataCache=await t.json();const n=document.getElementById("lang-filter");n.innerHTML='<option value="all">All Languages</option>',imageDataCache.languages.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=new Intl.DisplayNames(["en"],{type:"language"}).of(e)||e,n.appendChild(t)}),n.onchange=()=>renderImages(imageDataCache),renderImages(imageDataCache)}catch(e){showToast(e.message,!0);for(const t of e)document.getElementById(`gallery-${t}`).innerHTML=`<p class="text-red-500 col-span-full text-center">${e.message}</p>`}}
    function renderImages(e){const t=document.getElementById("lang-filter").value;["posters","backdrops","logos"].forEach(o=>{const n=document.getElementById(`gallery-${o}`);let a=e[o];"all"!==t&&(a=a.filter(e=>e.lang===t||null===e.lang)),n.innerHTML=a.map(e=>`<img src="https://image.tmdb.org/t/p/w300${e.path}" class="rounded-md cursor-pointer hover:opacity-75 transition-opacity" onclick="selectImage('${o.slice(0,-1)}', 'https://image.tmdb.org/t/p/original${e.path}')">`).join("")||'<p class="text-gray-400 col-span-full text-center py-8">No images found for this language.</p>'})}
    function switchTab(e){["posters","backdrops","logos"].forEach(t=>{document.getElementById(`gallery-${t}`).classList.add("hidden"),document.getElementById(`tab-${t}`).classList.remove("border-indigo-500","text-indigo-600"),document.getElementById(`tab-${t}`).classList.add("border-transparent","text-gray-500")}),document.getElementById(`gallery-${e}`).classList.remove("hidden"),document.getElementById(`tab-${e}`).classList.add("border-indigo-500","text-indigo-600"),document.getElementById(`tab-${e}`).classList.remove("border-transparent","text-gray-500")}
    function selectImage(e,t){const n=document.querySelector(`[name="${e}"]`);n&&(n.value=t),"poster"===e&&(document.getElementById("poster-preview").src=t),closeImageSelector(),setUnsavedChanges(true)}
</script>
{% endblock %}
