{% extends "base.html" %}
{% block title %}Manage {{ media_type|title }}s{% endblock %}
{% block content %}
<h1 class="text-3xl font-bold mb-6 text-gray-900">Manage {{ media_type|title }}s</h1>
<div class="bg-white p-4 rounded-xl shadow-md mb-6">
    <input type="text" id="search-input" placeholder="Search by title..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500">
</div>

<div id="loading" class="text-center py-12 hidden"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>
<div id="media-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6"></div>
<div id="pagination" class="flex justify-center mt-8"></div>
<div id="no-results" class="text-center py-12 hidden"><p class="text-gray-500">No results found.</p></div>

<script>
    const mediaType = '{{ media_type }}';
    let currentPage = 1;
    let searchTimeout;

    async function loadMedia(page = 1, search = '') {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('media-grid').innerHTML = '';
        document.getElementById('pagination').innerHTML = '';
        document.getElementById('no-results').classList.add('hidden');

        try {
            const response = await fetch(`/api/media/${mediaType}?page=${page}&search=${encodeURIComponent(search)}`);
            if (!response.ok) throw new Error('Failed to fetch media.');
            const data = await response.json();
            
            document.getElementById('loading').classList.add('hidden');
            const grid = document.getElementById('media-grid');

            if (data.items.length === 0) {
                document.getElementById('no-results').classList.remove('hidden');
                return;
            }

            data.items.forEach(item => {
                const card = `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden group">
                        <a href="/edit/${mediaType}/${item.tmdb_id}">
                            <div class="relative">
                                <img src="${item.poster || 'https://via.placeholder.com/300x450'}" alt="${item.title}" class="w-full h-auto object-cover aspect-[2/3]">
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all"></div>
                            </div>
                            <div class="p-3">
                                <h3 class="font-semibold text-sm truncate">${item.title}</h3>
                                <p class="text-xs text-gray-500">${item.release_year}</p>
                            </div>
                        </a>
                    </div>
                `;
                grid.innerHTML += card;
            });

            renderPagination(data.total, data.page, data.page_size);
        } catch (error) {
            document.getElementById('loading').textContent = 'Error loading media.';
            console.error(error);
        }
    }

    function renderPagination(total, page, pageSize) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById('pagination');
        if (totalPages <= 1) return;
        
        let html = '';
        for (let i = 1; i <= totalPages; i++) {
            const activeClass = i === page ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100';
            html += `<button onclick="loadMedia(${i}, document.getElementById('search-input').value)" class="px-4 py-2 border rounded-md text-sm font-medium ${activeClass} transition-colors">${i}</button>`;
        }
        pagination.innerHTML = `<div class="flex space-x-2">${html}</div>`;
    }

    document.getElementById('search-input').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadMedia(1, e.target.value);
        }, 300);
    });

    document.addEventListener('DOMContentLoaded', () => loadMedia());
</script>
{% endblock %}
